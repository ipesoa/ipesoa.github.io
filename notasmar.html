<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Algunas notas del mar - Editorial I.PESOA</title>
    
    <!-- Enlace a tu CSS principal -->
    <link rel="stylesheet" href="style.css">
    
    <!-- Librerías p5.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/addons/p5.sound.min.js"></script>
    
    <style>
        /* --- ESTILOS GENERALES --- */
        body {
            margin: 0;
            padding: 0;
            overflow: hidden; /* Sin scroll */
            background-color: transparent; 
            font-family: var(--font-main, 'Georgia', serif);
            color: var(--text-color, #000);
            height: 100vh;
            width: 100vw;
        }

        /* --- LIENZO P5 (FONDO) --- */
        canvas {
            display: block;
            position: fixed; /* Fijo a la pantalla */
            top: 0;
            left: 0;
            z-index: -1; /* SIEMPRE DETRÁS DE TODO */
        }

        /* --- HEADER Y TÍTULO (SIEMPRE VISIBLES) --- */
        #info-container {
            position: fixed; /* CAMBIO CLAVE: Fixed para que no se mueva nunca */
            top: 0;
            left: 0;
            width: 100%;
            text-align: center;
            z-index: 9999; /* SIEMPRE DELANTE DE TODO */
            padding-top: 2rem;
            pointer-events: none; /* Deja pasar los clicks al canvas */
        }

        header h1 {
            font-size: 1.5rem;
            letter-spacing: 0.1em;
            margin: 0;
            text-transform: uppercase;
            /* Fondo blanco semitransparente para legibilidad */
            background-color: rgba(255,255,255,0.7); 
            display: inline-block;
            padding: 5px 15px;
            border-radius: 2px;
        }

        main h2 {
            font-weight: normal;
            font-style: italic;
            margin-top: 1.5rem;
            font-size: 1.2rem;
            background-color: rgba(255,255,255,0.7);
            display: inline-block;
            padding: 5px 15px;
            border-radius: 2px;
        }

        /* --- BOTÓN VOLVER --- */
        #nav-footer {
            position: fixed;
            bottom: 30px;
            width: 100%;
            text-align: center;
            z-index: 10000; /* Aún más arriba para asegurar el click */
        }

        #nav-footer a {
            color: var(--text-color, #000);
            text-decoration: none;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 8px 15px;
            font-size: 0.9rem;
            border-bottom: 1px solid transparent;
            transition: border-bottom 0.3s;
            pointer-events: auto;
        }

        #nav-footer a:hover {
            border-bottom: 1px solid var(--text-color, #000);
        }

        /* --- TEXTO DE AYUDA --- */
        #start-hint {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.9rem;
            opacity: 0.6;
            pointer-events: none;
            transition: opacity 0.5s;
            z-index: 5000;
            background-color: rgba(255,255,255,0.8);
            padding: 10px;
        }
    </style>
</head>
<body>

    <!-- Header y Título -->
    <div id="info-container">
        <header>
            <h1>EDITORIAL I.PESOA</h1>
        </header>
        <main>
            <h2>Algunas notas del mar</h2>
        </main>
    </div>

    <!-- Indicador de click -->
    <div id="start-hint">Haz clic en la pantalla para escuchar</div>

    <!-- Botón Volver -->
    <div id="nav-footer">
        <a href="articulos-publicos.html">Volver a Artículos Públicos</a>
    </div>

    <script>
        // --- CONFIGURACIÓN DE AUDIO ---
        let scaleBbMinorPent = [58, 61, 63, 66, 68]; // Octava grave
        
        let noteColors = {}; 
        let voices = [];
        let numVoices = 18; 
        
        // AQUÍ ESTÁN LAS 3 ONDAS DEFINIDAS:
        let waveTypes = ['sine', 'triangle', 'sawtooth']; 

        let masterVol = 0.6; 
        let baseAmp = 0.05; 
        let minCircleSize, maxCircleSize;
        let nextTriggerTime = 0; 
        let circles = [];
        let compressor; 
        let audioStarted = false;

        function setup() {
            // Creamos el lienzo
            let cnv = createCanvas(windowWidth, windowHeight);
            // Aseguramos por código también que se vaya al fondo
            cnv.style('z-index', '-1');
            cnv.style('position', 'fixed');

            updateSizeLimits();

            colorMode(HSL, 360, 100, 100, 1);
            noStroke();
            ellipseMode(RADIUS);

            for (let i = 0; i < scaleBbMinorPent.length; i++) {
                noteColors[scaleBbMinorPent[i]] = random(0, 360); 
            }

            compressor = new p5.Compressor();
            compressor.threshold(-30); 
            compressor.ratio(12);      
            compressor.attack(0.01);
            compressor.release(0.25);
            compressor.connect();      

            for (let i = 0; i < numVoices; i++) {
                let osc = new p5.Oscillator('sine'); 
                let env = new p5.Envelope();
                let filt = new p5.LowPass();
                
                osc.disconnect();
                osc.connect(filt);
                filt.disconnect(); 
                filt.connect(compressor); 
                
                osc.start();
                osc.amp(0); 

                voices.push({ osc, env, filt, isPlaying: false });
            }
        }

        function draw() {
            // Fondo blanco casi transparente. 
            // Al estar el canvas en z-index -1, esto NO TAPA el texto HTML.
            background(0, 0, 100, 0.2); 

            let currentTime = millis();

            if (audioStarted && currentTime >= nextTriggerTime) {
                triggerNextChord();
                nextTriggerTime = currentTime + random(3000, 6000);
            }

            for (let i = circles.length - 1; i >= 0; i--) {
                let c = circles[i];
                c.x += c.vx;
                c.y += c.vy;

                let elapsed = (currentTime - c.startTime) / 1000.0;
                let adsr = c.adsr;
                let totalDur = adsr.a + adsr.d + adsr.sTime + adsr.r;
                let currentAlpha = 0;

                if (elapsed < adsr.a) {
                    currentAlpha = map(elapsed, 0, adsr.a, 0, c.maxAlpha);
                } else if (elapsed < adsr.a + adsr.d + adsr.sTime) {
                    currentAlpha = c.maxAlpha;
                } else if (elapsed < totalDur) {
                    let startRel = adsr.a + adsr.d + adsr.sTime;
                    currentAlpha = map(elapsed, startRel, totalDur, c.maxAlpha, 0);
                } else {
                    voices[c.voiceIndex].isPlaying = false; 
                    circles.splice(i, 1); 
                    continue; 
                }

                currentAlpha = constrain(currentAlpha, 0, 1);
                fill(c.hue, c.sat, c.light, currentAlpha);
                ellipse(c.x, c.y, c.size, c.size);
            }
        }

        function triggerNextChord() {
            let notesToPlay = floor(random(2, 3)); 
            for (let k = 0; k < notesToPlay; k++) playNote();
        }

        function playNote() {
            let vIndex = voices.findIndex(v => !v.isPlaying);
            if (vIndex === -1) return;

            let v = voices[vIndex];
            v.isPlaying = true; 

            let note = random(scaleBbMinorPent);
            let freq = midiToFreq(note);
            
            // --- SELECCIÓN ALEATORIA DE LAS 3 ONDAS ---
            // Aquí se elige una al azar de ['sine', 'triangle', 'sawtooth']
            let wave = random(waveTypes); 
            v.osc.setType(wave);

            let volMult = 1.0; 
            
            // Lógica para equilibrar el volumen de cada tipo
            if (wave === 'sawtooth') { 
                volMult = 0.4; 
                v.filt.freq(random(200, 1500));
            } 
            else if (wave === 'triangle') { 
                volMult = 0.7; 
                v.filt.freq(random(300, 2500));
            } 
            else { 
                // wave es 'sine'
                volMult = 0.6; 
                v.filt.freq(random(500, 3500)); 
            }

            v.filt.res(random(0.1, 2.0)); 
            
            let finalAmp = baseAmp * volMult;

            let atk = random(0.5, 2.0);
            let susTime = random(2.0, 5.0);
            let rel = random(4.0, 12.0);

            v.env.setADSR(atk, 0.5, 0.5, rel);
            v.env.setRange(finalAmp, 0); 
            v.osc.freq(freq);
            v.env.play(v.osc, 0, susTime);

            circles.push({
                voiceIndex: vIndex,
                x: random(width * 0.1, width * 0.9),
                y: random(height * 0.1, height * 0.9),
                vx: random(-0.15, 0.15), 
                vy: random(-0.15, 0.15),
                size: random(minCircleSize, maxCircleSize), 
                hue: noteColors[note],            
                sat: random(70, 100),    
                light: random(50, 70),   
                maxAlpha: random(0.05, 0.12), 
                startTime: millis(),
                adsr: { a: atk, d: 0.5, sTime: susTime, r: rel }
            });
        }

        function updateSizeLimits() {
            if (width < 600) { 
                minCircleSize = 80; maxCircleSize = 300; 
            } else { 
                minCircleSize = 150; maxCircleSize = 650; 
            }
        }

        function windowResized() {
            resizeCanvas(windowWidth, windowHeight);
            updateSizeLimits();
        }

        function mousePressed() {
            let footer = document.getElementById('nav-footer');
            if (footer.contains(event.target)) return;

            if (!audioStarted) {
                userStartAudio().then(() => {
                    outputVolume(masterVol); 
                    audioStarted = true;
                    nextTriggerTime = millis();
                    let hint = document.getElementById('start-hint');
                    if(hint) hint.style.opacity = 0;
                });
            }
        }
    </script>
</body>
</html>
